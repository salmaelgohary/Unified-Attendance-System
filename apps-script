var ss = SpreadsheetApp.openById('1nQfiTPmmA-pZAfxRckCYzHnbL-j_BealqrMpHHr_OcQ');
var sheet = ss.getSheetByName('Sheet1');
var timezone = "America/Toronto";


// Make sure headers include Sign In/Out
if (sheet.getLastRow() === 0) {
  sheet.appendRow(["Name", "Date", "Time", "Status", "Work Type", "Notes", "Master Notes"]); //title columns

  // Bold the header row
  sheet.getRange(1, 1, 1, 7).setFontWeight("bold"); 
}

function doGet(e){
  Logger.log(JSON.stringify(e));
  if (e.parameter == 'undefined') {
    return ContentService.createTextOutput("Received data is undefined");
  }

  var Curr_Date = new Date();
  var Curr_Time = Utilities.formatDate(Curr_Date, timezone, 'HH:mm:ss');
  var name = stripQuotes(e.parameters.name);

  // Determine Sign In or Sign Out
  var status = "Sign In"; // default
  var data = sheet.getDataRange().getValues();
  for (var i = data.length - 1; i >= 0; i--) {
    if (data[i][0] === name) { // column A is Name
      if (data[i][3] === "Sign In") { // last entry was Sign In without a Sign Out
        status = "Sign Out";
      }
      break;
    }
  }

  var nextRow = sheet.getLastRow() + 1;
  sheet.getRange("A" + nextRow).setValue(name);
  sheet.getRange("B" + nextRow).setValue(Curr_Date);
  sheet.getRange("C" + nextRow).setValue(Curr_Time);
  sheet.getRange("D" + nextRow).setValue(status); // column D = Status

  // Add dropdown for Work Type if this is a Sign In
  if (status === "Sign In") {
    var workTypes = ["SHOP", "OFFICE", "WELDING", "TRAINING", "ISO", "ERP", "HEALTH SAFETY"];
    var rule = SpreadsheetApp.newDataValidation()
        .requireValueInList(workTypes, true)
        .setAllowInvalid(false)
        .build();
    sheet.getRange("E" + nextRow).setDataValidation(rule);
  }

  // Check if data is being accessed by esp32. If yes provide with sign in/out status directly (to reply text)
  if (e.parameter.from === "esp32") {
    // Return only the status (plain text)
    return ContentService.createTextOutput(status);
  }

  return ContentService.createTextOutput("Card holder name is stored in column A with " + status);
}


function stripQuotes(value) {
  return value.toString().replace(/^["']|['"]$/g, "");
}

function doPost(e) {
  var val = e.parameter.value;
  
  if (e.parameter.value !== undefined){
    var range = sheet.getRange('A2');
    range.setValue(val);
  }
}
