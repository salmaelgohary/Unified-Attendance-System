var ss = SpreadsheetApp.openById('1nQfiTPmmA-pZAfxRckCYzHnbL-j_BealqrMpHHr_OcQ');
var sheet = ss.getSheetByName('Sheet1');
var timezone = "America/Toronto";


// Make sure headers include Sign In/Out
if (sheet.getLastRow() === 0) {
  sheet.appendRow(["Name", "Date", "Time", "Status"]); // Add Status column
}

function doGet(e){
  Logger.log(JSON.stringify(e));
  if (e.parameter == 'undefined') {
    return ContentService.createTextOutput("Received data is undefined");
  }

  var Curr_Date = new Date();
  var Curr_Time = Utilities.formatDate(Curr_Date, timezone, 'HH:mm:ss');
  var name = stripQuotes(e.parameters.name);

  // Determine Sign In or Sign Out
  var status = "Sign In"; // default
  var data = sheet.getDataRange().getValues();
  for (var i = data.length - 1; i >= 0; i--) {
    if (data[i][0] === name) { // column A is Name
      if (data[i][3] === "Sign In") { // last entry was Sign In without a Sign Out
        status = "Sign Out";
      }
      break;
    }
  }

  var nextRow = sheet.getLastRow() + 1;
  sheet.getRange("A" + nextRow).setValue(name);
  sheet.getRange("B" + nextRow).setValue(Curr_Date);
  sheet.getRange("C" + nextRow).setValue(Curr_Time);
  sheet.getRange("D" + nextRow).setValue(status); // column D = Status

  return ContentService.createTextOutput("Card holder name is stored in column A with " + status);
}


function stripQuotes(value) {
  return value.toString().replace(/^["']|['"]$/g, "");
}

function doPost(e) {
  var val = e.parameter.value;
  
  if (e.parameter.value !== undefined){
    var range = sheet.getRange('A2');
    range.setValue(val);
  }
}

function addWorkTypeDropdowns() {
  var data = sheet.getDataRange().getValues();
  
  // Define the allowed options for "Work Type"
  var workTypes = ["SHOP", "OFFICE", "WELDING", "TRAINING", "ISO", "ERP", "HEALTH SAFETY"];
  
  for (var i = 1; i < data.length; i++) { // skip header row
    var status = data[i][3];  // column D (0-based index)
    var range = sheet.getRange(i + 1, 5); // column E (Work Type)
    
    if (status === "Sign In") {
      var rule = SpreadsheetApp.newDataValidation()
        .requireValueInList(workTypes, true)
        .setAllowInvalid(false)
        .build();
      range.setDataValidation(rule);
    } else {
      range.clearDataValidations();
    }
  }
}

function onEdit(e) {
  var range = e.range;
  var sheet = range.getSheet();
  
  if (sheet.getName() === "Sheet1" && range.getColumn() === 4) { // column D = Status
    addWorkTypeDropdowns();
  }
}
